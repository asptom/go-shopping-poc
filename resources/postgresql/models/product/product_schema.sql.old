-- Products Schema

-- This schema is used to manage product-related data

-- Credentials are managed outside of source control in the .ENV file
-- There is a corresponding <domain>_db.sql script that is used to initialize the database
-- This script is used to create the customers schema in PostgreSQL

-- The following lines will be used to set the DB, USER, and PGPASSWORD used to 
-- run the psqlclient that executes this script
-- DB: $PSQL_PRODUCT_DB
-- USER: $PSQL_PRODUCT_ROLE
-- PGPASSWORD: $PSQL_PRODUCT_PASSWORD

DROP SCHEMA IF EXISTS products CASCADE;
CREATE SCHEMA products;

SET search_path TO products;

-- Brand

DROP TABLE IF EXISTS products.Brand;
CREATE TABLE products.Brand (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL UNIQUE,
  website TEXT,
  created_at timestamp not null default CURRENT_TIMESTAMP,
  updated_at timestamp not null default CURRENT_TIMESTAMP
);

-- Currency

DROP TABLE IF EXISTS products.Currency;
CREATE TABLE products.Currency (
  code CHAR(3) PRIMARY KEY, -- USD, EUR, etc
  symbol TEXT,
  name TEXT
);

-- Category (hierarchy: parent_id -> child)

DROP TABLE IF EXISTS products.Category;
CREATE TABLE products.Category (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  slug TEXT NOT NULL,
  description TEXT,
  parent_id UUID REFERENCES products.Category(id) ON DELETE SET NULL,
  depth INT DEFAULT 0,
  created_at timestamp not null default CURRENT_TIMESTAMP,
  updated_at timestamp not null default CURRENT_TIMESTAMP,
  UNIQUE(slug, parent_id)
);

CREATE INDEX idx_categories_parent ON products.Category(parent_id);

-- Product (logical product)

DROP TABLE IF EXISTS products.Product;
CREATE TABLE products.Product (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  sku TEXT UNIQUE,            -- optional global SKU
  product_id_text TEXT,      -- preserve source CSV product_id
  name TEXT NOT NULL,
  description TEXT,
  brand_id UUID REFERENCES products.Brand(id),
  root_category_id UUID REFERENCES products.Category(id),
  currency CHAR(3) REFERENCES products.Currency(code),
  price NUMERIC(12,2),
  final_price NUMERIC(12,2),
  active BOOLEAN DEFAULT TRUE,
  created_at timestamp not null default CURRENT_TIMESTAMP,
  updated_at timestamp not null default CURRENT_TIMESTAMP
);

CREATE INDEX idx_product_brand ON products.Product(brand_id);
CREATE INDEX idx_product_rootcat ON products.Product(root_category_id);

-- Product variant (size/color/each sellable item)

DROP TABLE IF EXISTS products.ProductVariant;
CREATE TABLE products.ProductVariant (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id UUID REFERENCES products.Product(id) ON DELETE CASCADE,
  sku TEXT UNIQUE,
  barcode TEXT,
  attributes JSONB,       -- {"color":"Grey","size":"one-size"}
  price NUMERIC(12,2),    -- variant specific price (nullable)
  final_price NUMERIC(12,2),
  in_stock BOOLEAN DEFAULT TRUE,
  stock_quantity INT DEFAULT 0,
  created_at timestamp not null default CURRENT_TIMESTAMP,
  updated_at timestamp not null default CURRENT_TIMESTAMP
);

CREATE INDEX idx_variant_product ON products.ProductVariant(product_id);

-- Flexible attributes for products (searchable facets)

DROP TABLE IF EXISTS products.ProductAttribute;
CREATE TABLE products.ProductAttribute (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id UUID REFERENCES products.Product(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  value TEXT NOT NULL,
  created_at timestamp not null default CURRENT_TIMESTAMP
);

CREATE INDEX idx_attr_product ON products.ProductAttribute(product_id);

-- Product image metadata

DROP TABLE IF EXISTS products.ProductImage;
CREATE TABLE products.ProductImage (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  product_id UUID REFERENCES products.Product(id) ON DELETE CASCADE,
  variant_id UUID REFERENCES products.ProductVariant(id) ON DELETE SET NULL,
  url_original TEXT,        -- original remote URL from CSV
  local_path TEXT,          -- local filesystem path after download
  mime_type TEXT,
  file_size_bytes BIGINT,
  width INT,
  height INT,
  is_main BOOLEAN DEFAULT FALSE,
  position INT DEFAULT 0,
  upload_state TEXT DEFAULT 'downloaded', -- downloaded|uploaded|failed
  minio_bucket TEXT,
  minio_object TEXT,
  minio_url TEXT,           -- optional public or presigned path
  created_at timestamp not null default CURRENT_TIMESTAMP,
  updated_at timestamp not null default CURRENT_TIMESTAMP
);

CREATE INDEX idx_image_product ON products.ProductImage(product_id);
CREATE INDEX idx_image_state ON products.ProductImage(upload_state);

-- Simple audit table for ingestion runs

CREATE TABLE products.IngestionRun (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  started_at timestamp not null default CURRENT_TIMESTAMP,
  finished_at timestamp,
  rows_processed INT DEFAULT 0,
  errors INT DEFAULT 0,
  note TEXT
);

-- ==========================================================
-- TRIGGER TO UPDATE updated_at AUTOMATICALLY
-- ==========================================================

CREATE OR REPLACE FUNCTION update_timestamp()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_product_timestamp
    BEFORE UPDATE ON products.Product
    FOR EACH ROW EXECUTE FUNCTION update_timestamp();

CREATE TRIGGER update_product_image_timestamp
    BEFORE UPDATE ON products.ProductImage
    FOR EACH ROW EXECUTE FUNCTION update_timestamp();

CREATE TRIGGER update_product_variant_timestamp
    BEFORE UPDATE ON products.ProductVariant
    FOR EACH ROW EXECUTE FUNCTION update_timestamp();

CREATE TRIGGER update_brand_timestamp
    BEFORE UPDATE ON products.Brand
    FOR EACH ROW EXECUTE FUNCTION update_timestamp();

CREATE TRIGGER update_category_timestamp
    BEFORE UPDATE ON products.Category
    FOR EACH ROW EXECUTE FUNCTION update_timestamp();

-- ==========================================================
-- Outbox pattern for event sourcing
-- This schema is used to manage outbox events for this database
-- ==========================================================

DROP SCHEMA IF EXISTS outbox CASCADE;
CREATE SCHEMA outbox;
SET search_path TO outbox;

DROP TABLE IF EXISTS outbox.outbox;
CREATE TABLE outbox.outbox (
    id bigint GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    event_type text not null,
    topic text not null,
    event_payload jsonb not null,
    created_at timestamp DEFAULT CURRENT_TIMESTAMP not null,
    times_attempted integer DEFAULT 0,
    published_at timestamp
);

CREATE INDEX IF NOT EXISTS idx_outbox_unpublished ON outbox.outbox (published_at) WHERE published_at IS NULL;

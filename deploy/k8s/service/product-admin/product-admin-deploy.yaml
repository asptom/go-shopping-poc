apiVersion: v1
kind: Service
metadata:
  name: product-admin-svc
  namespace: shopping
  labels:
    app.kubernetes.io/name: product-admin-svc
    app.kubernetes.io/version: v1.0
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: product-admin
    app.kubernetes.io/version: v1.0
  ports:
    - name: http
      port: 80
      targetPort: 8082
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: product-admin
  namespace: shopping
  labels:
    app.kubernetes.io/name: product-admin
    app.kubernetes.io/version: v1.0
spec:
  serviceName: product-admin-svc
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: product-admin
      app.kubernetes.io/version: v1.0
  template:
    metadata:
      labels:
        app.kubernetes.io/name: product-admin
        app.kubernetes.io/version: v1.0
    spec:
      containers:
        - name: product-admin
          image: localhost:5000/go-shopping-poc/product-admin:1.0
          imagePullPolicy: Always
          env:
            # Platform config (selective)
            - name: LOG_LEVEL
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: LOG_LEVEL

            # Database Connection Pool Settings
            - name: DATABASE_MAX_OPEN_CONNS
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: DATABASE_MAX_OPEN_CONNS
            - name: DATABASE_MAX_IDLE_CONNS
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: DATABASE_MAX_IDLE_CONNS
            - name: DATABASE_CONN_MAX_LIFETIME
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: DATABASE_CONN_MAX_LIFETIME
            - name: DATABASE_CONN_MAX_IDLE_TIME
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: DATABASE_CONN_MAX_IDLE_TIME
            - name: DATABASE_CONNECT_TIMEOUT
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: DATABASE_CONNECT_TIMEOUT
            - name: DATABASE_QUERY_TIMEOUT
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: DATABASE_QUERY_TIMEOUT
            - name: DATABASE_HEALTH_CHECK_INTERVAL
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: DATABASE_HEALTH_CHECK_INTERVAL
            - name: DATABASE_HEALTH_CHECK_TIMEOUT
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: DATABASE_HEALTH_CHECK_TIMEOUT

            # Kafka Configuration
            - name: KAFKA_BROKERS
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: KAFKA_BROKERS

            # Outbox Pattern Configuration
            - name: OUTBOX_BATCH_SIZE
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: OUTBOX_BATCH_SIZE
            - name: OUTBOX_PROCESS_INTERVAL
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: OUTBOX_PROCESS_INTERVAL
            - name: OUTBOX_OPERATION_TIMEOUT
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: OUTBOX_OPERATION_TIMEOUT
            - name: OUTBOX_MAX_RETRIES
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: OUTBOX_MAX_RETRIES

            # CORS Configuration
            - name: CORS_ALLOWED_ORIGINS
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: CORS_ALLOWED_ORIGINS
            - name: CORS_ALLOWED_METHODS
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: CORS_ALLOWED_METHODS
            - name: CORS_ALLOWED_HEADERS
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: CORS_ALLOWED_HEADERS
            - name: CORS_ALLOW_CREDENTIALS
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: CORS_ALLOW_CREDENTIALS
            - name: CORS_MAX_AGE
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: CORS_MAX_AGE

            # MinIO Configuration
            - name: MINIO_ENDPOINT_KUBERNETES
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: MINIO_ENDPOINT_KUBERNETES
            - name: MINIO_ENDPOINT_LOCAL
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: MINIO_ENDPOINT_LOCAL
            - name: MINIO_TLS_VERIFY
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: MINIO_TLS_VERIFY
            - name: MINIO_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-bootstrap-secret
                  key: MINIO_ACCESS_KEY
            - name: MINIO_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-bootstrap-secret
                  key: MINIO_SECRET_KEY

            # Keycloak Configuration
            - name: KEYCLOAK_ISSUER
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: KEYCLOAK_ISSUER
            - name: KEYCLOAK_JWKS_URL
              valueFrom:
                configMapKeyRef:
                  name: platform-config
                  key: KEYCLOAK_JWKS_URL
            
            # Service config (selective)
            - name: PRODUCT_SERVICE_PORT
              valueFrom:
                configMapKeyRef:
                  name: product-admin-config
                  key: PRODUCT_SERVICE_PORT
            - name: PRODUCT_WRITE_TOPIC
              valueFrom:
                configMapKeyRef:
                  name: product-admin-config
                  key: PRODUCT_WRITE_TOPIC
            - name: PRODUCT_GROUP
              valueFrom:
                configMapKeyRef:
                  name: product-admin-config
                  key: PRODUCT_GROUP
            - name: MINIO_BUCKET
              valueFrom:
                configMapKeyRef:
                  name: product-admin-config
                  key: MINIO_BUCKET
            - name: IMAGE_CACHE_DIR
              valueFrom:
                configMapKeyRef:
                  name: product-admin-config
                  key: IMAGE_CACHE_DIR
            - name: IMAGE_CACHE_MAX_AGE
              valueFrom:
                configMapKeyRef:
                  name: product-admin-config
                  key: IMAGE_CACHE_MAX_AGE
            - name: IMAGE_CACHE_MAX_SIZE
              valueFrom:
                configMapKeyRef:
                  name: product-admin-config
                  key: IMAGE_CACHE_MAX_SIZE
            - name: CSV_BATCH_SIZE
              valueFrom:
                configMapKeyRef:
                  name: product-admin-config
                  key: CSV_BATCH_SIZE
            - name: DB_URL
              valueFrom:
                secretKeyRef:
                  name: product-db-secret
                  key: DB_URL
            - name: KEYCLOAK_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: product-admin-keycloak-secret
                  key: KEYCLOAK_CLIENT_SECRET
            
          ports:
            - containerPort: 8082
          readinessProbe:
            httpGet:
              path: /health
              port: 8082
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: product-admin-ingress
  namespace: shopping
  labels:
    app.kubernetes.io/name: product-admin-ingress
    app.kubernetes.io/token: v1.0
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: websecure,web
spec:
  rules:
    - host: pocstore.local
      http:
        paths:
          - path: /api/v1/admin/products
            pathType: Prefix
            backend:
              service:
                name: product-admin-svc
                port:
                  number: 80
  tls:
    - hosts:
        - pocstore.local
      secretName: pocstorelocal-tls

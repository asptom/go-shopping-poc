apiVersion: batch/v1
kind: Job
metadata:
  name: keycloak-db-bootstrap
  namespace: keycloak
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    spec:
      restartPolicy: OnFailure
      serviceAccountName: db-bootstrap
      containers:
      - name: bootstrap
        image: postgres:18.0
        env:
          - name: psql_host
            value: postgres.postgres.svc.cluster.local
          - name: psql_username
            valueFrom:
              secretKeyRef:
                name: postgres-admin-bootstrap-secret
                key: POSTGRES_USER
          - name: PGPASSWORD
            valueFrom:
              secretKeyRef:
                name: postgres-admin-bootstrap-secret
                key: POSTGRES_PASSWORD
          - name: psql_db
            valueFrom:
              secretKeyRef:
                name: postgres-admin-bootstrap-secret
                key: POSTGRES_DB
        command:
        - sh
        - -c
        - |
          set -e

          DB_NAME="keycloak_db"
          APP_USER="keycloak_user"
          APP_PASS="`openssl rand -hex 16`"
          RO_USER="keycloak_rouser"
          RO_PASS="`openssl rand -hex 16`"

          psql <<'SQL'
          DO \$BODY\$
          BEGIN
            DROP ROLE IF EXISTS :"APP_USER";
            DROP ROLE IF EXISTS :"RO_USER";
            DROP DATABASE IF EXISTS :"DB_NAME";
            CREATE ROLE :"APP_USER" WITH LOGIN PASSWORD :'APP_PASSWORD';
            CREATE ROLE :"RO_USER" WITH LOGIN PASSWORD :'RO_PASSWORD';
            CREATE DATABASE :"DB_NAME" OWNER :"APP_USER" TEMPLATE template0 ENCODING 'UTF8';
            GRANT ALL PRIVILEGES ON DATABASE :"DB_NAME" TO :"APP_USER";
            GRANT CONNECT ON DATABASE :"DB_NAME" TO :"RO_USER";
          END
          \$BODY\$;
          SQL

          kubectl create secret generic keycloak-db-secret -n keycloak \
            --from-literal=db_name=keycloak \
            --from-literal=username=keycloak_user \
            --from-literal=password="$$$$APP_PASS" \
            --from-literal=ro_username=keycloak_rouser \
            --from-literal=ro_password="$$RO_PASS" \
            --dry-run=client -o yaml | kubectl apply -f -
